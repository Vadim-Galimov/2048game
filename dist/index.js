(()=>{"use strict";class e{constructor(){if(e._instance)return e._instance;e._instance=this}init(){this.setKeyboardController(this),this.setMouseController(this),this.setTouchpadController(this),this.setButtonsController(this)}setKeyboardController(e){let t=new Array;document.addEventListener("keydown",(function(){switch(event.code){case"ArrowUp":e.doMove("up");break;case"ArrowDown":e.doMove("down");break;case"ArrowLeft":e.doMove("left");break;case"ArrowRight":e.doMove("right");break;case"Enter":event.preventDefault(),e.pressEnter()}t.push(event.code),t.length>5&&t.shift(),t.join()==["KeyA","KeyD","KeyM","KeyI","KeyN"].join()&&e.openAdminPanel()}))}setMouseController(t){let i,s,l,n;function r(r){return null===event||"touchstart"==event.type?0:(s=r.x,n=r.y,function(){let r,a=[s-i,n-l];if(Math.abs(a[0])+Math.abs(a[1])<200)return 0;Math.abs(a[0])>Math.abs(a[1])?e.axis="x":e.axis="y","y"==e.axis&&(r=a[1]>0?"down":"up"),"x"==e.axis&&(r=a[0]>0?"right":"left"),t.doMove(r)}(),void(Math.abs(s-i)+Math.abs(n-l)<5&&t.buttonClick()))}document.addEventListener("mousedown",(function(e){return null===event||"touchstart"==event.type?0:(i=e.x,l=e.y,void document.addEventListener("mouseup",r,event))}),event),document.addEventListener("mousemove",t.checkMouseMove)}setTouchpadController(t){let i,s;function l(e,i,s){let l=e.x,n=e.y;Math.abs(i-l)+Math.abs(s-n)<5&&t.touchButtonClick(i,s)}document.addEventListener("touchstart",(function(l){document.addEventListener("touchmove",(function(e){l&&(i=e.touches[0].pageX-l.touches[0].pageX,s=e.touches[0].pageY-l.touches[0].pageY)}),event),document.addEventListener("touchend",(function(){return isNaN(Math.abs(i))||Math.abs(i)+Math.abs(s)<100?0:(Math.abs(i)>Math.abs(s)?e.axis="x":e.axis="y","y"==e.axis&&(moveTo=s>0?"down":"up"),"x"==e.axis&&(moveTo=i>0?"right":"left"),t.doMove(moveTo),void(l=null))}))}),event),document.addEventListener("touchstart",(function(){elem=document.getElementById("canvasBody");let e=event.touches[0]?.pageX,t=event.touches[0]?.pageY;document.addEventListener("touchend",l,event,e,t)}))}setButtonsController(e){document.getElementById("startNewGame").addEventListener("click",e.triggerButton),document.getElementById("makeLose").addEventListener("click",e.triggerButton),document.getElementById("makeWin").addEventListener("click",e.triggerButton),document.getElementById("makePrewinSituation").addEventListener("click",e.triggerButton),document.getElementById("makePreloseSituation").addEventListener("click",e.triggerButton)}doMove;checkMouseMove;buttonClick;touchButtonClick;pressEnter;openAdminPanel;triggerButton}class t{constructor(){if(t._instance)return t._instance;t._instance=this}size=80;minMargin=this.size/8;fullSize=4*this.size+5*this.minMargin;stepMargin=this.minMargin+this.size;textMarginSize=this.size/8*3;drawScore(e){let t=document.getElementById("canvasHead").getContext("2d");t.clearRect(0,0,canvasHead.width,canvasHead.height),t.font="bold "+35*this.size/80+"px sans-serif";let[i,s]=this.mathWidthHeight("SCORE:"+e,t);t.fillStyle="#bbada0";let l=i+this.textMarginSize,n=25*this.size/80,r=this.size/4,a=this.size/8;this.roundRect(t,(this.fullSize-l)/2-n,r,i+(this.fullSize-l)/2+n,r+s+2*a,20),t.strokeStyle="#776e65",this.roundRectStroke(t,(this.fullSize-l)/2-n,r,i+(this.fullSize-l)/2+n,r+s+2*a,20,5),t.fillStyle="#ebe4da",t.fillText("SCORE: "+e,(this.fullSize-l)/2,r+s+a)}runBodyDrawer(e,t){let i=setInterval((()=>{this.drawCells(t)}),10);setTimeout(clearInterval,e,i)}drawCells(e){let t=document.getElementById("canvasBody").getContext("2d");t.clearRect(0,0,canvasBody.width,canvasBody.height),this.drawBackground(),e.forEach((e=>{let i=e.valueOfDraw;switch(i){case 2:case 4:case 8:case 16:case 32:case 64:t.font="bold 50px sans-serif";break;case 128:case 256:case 512:t.font="bold 42px sans-serif";break;case 1024:case 2048:t.font="bold 35px sans-serif"}switch(i){case 2:t.fillStyle="#eee4da";break;case 4:t.fillStyle="#ede0c8";break;case 8:default:t.fillStyle="#f2b179";break;case 16:t.fillStyle="#f59563";break;case 32:t.fillStyle="#f67c5f";break;case 64:t.fillStyle="#f35c3d";break;case 128:t.fillStyle="#e7cf73";break;case 256:t.fillStyle="#ecca64";break;case 512:case 1024:t.fillStyle="#eac75c";break;case 2048:t.fillStyle="#e6bd4f"}switch(this.roundRect(t,e.x+e.sizePenalty-e.sizeBonus,e.y+e.sizePenalty-e.sizeBonus,e.x+this.size-e.sizePenalty+e.sizeBonus,e.y+this.size-e.sizePenalty+e.sizeBonus,3),i){case 2:case 4:default:t.fillStyle="#776e65";break;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:t.fillStyle="#f9f6f2"}let[s,l]=this.mathWidthHeight(i,t),n=(this.size-s)/2,r=(this.size-l)/2;t.fillText(i,e.x+n,e.y+r+l)}))}drawLose(){let e=document.getElementById("canvasBody").getContext("2d");e.fillStyle="rgba(255, 255, 255, 0.5)",this.roundRect(e,0,0,this.fullSize,this.fullSize,10),e.fillStyle="#776e65",e.font="bold 50px sans-serif";let[t,i]=this.mathWidthHeight("GAME OVER!",e),s=(this.fullSize-t)/2,l=(this.fullSize-i)/2;e.fillText("GAME OVER!",s,l+i)}drawWin(){let e=document.getElementById("canvasBody").getContext("2d");e.fillStyle="rgba(255, 215, 0, 0.5)",this.roundRect(e,0,0,this.fullSize,this.fullSize,10),e.fillStyle="#f9f6f2",e.font="bold 50px sans-serif";let[t,i]=this.mathWidthHeight("YOU WIN!",e),s=(this.fullSize-t)/2,l=(this.fullSize-i)/2;e.fillText("YOU WIN!",s,l+i)}drawBackground(){let e=document.getElementById("canvasBody").getContext("2d");e.fillStyle="#776e65",this.roundRect(e,0,0,this.fullSize,this.fullSize,10),e.fillStyle="#bbada0";for(let t=0;t<4;t++)for(let i=0;i<4;i++){let s=this.minMargin+this.stepMargin*i,l=this.minMargin+this.stepMargin*t;this.roundRect(e,s,l,s+this.size,l+this.size,3)}}drawButton(e){let t=document.getElementById("canvasBody").getContext("2d");t.fillStyle="#8f7a66",t.font="bold "+this.size/4+"px sans-serif";let[i,s]=this.mathWidthHeight("Try again",t),l=i+this.textMarginSize;return this.roundRect(t,(this.fullSize-l)/2,220,i+30+(this.fullSize-l)/2,s+15+220,3),t.fillStyle="#f9f6f2",t.fillText("Try again",(this.fullSize-i-10)/2+2,244),[(this.fullSize-l)/2,220,i+30+(this.fullSize-l)/2,s+15+220]}roundRect(e,t,i,s,l,n){n=Math.min(n,(s-t)/2,(l-i)/2),e.beginPath(),e.moveTo(t+n,i),e.lineTo(s-n,i),e.arcTo(s,i,s,i+n,n),e.lineTo(s,l-n),e.arcTo(s,l,s-n,l,n),e.lineTo(t+n,l),e.arcTo(t,l,t,l-n,n),e.lineTo(t,i+n),e.arcTo(t,i,t+n,i,n),e.fill()}roundRectStroke(e,t,i,s,l,n,r){e.lineWidth=r,n=Math.min(n,(s-t)/2,(l-i)/2),e.beginPath(),e.moveTo(t+n,i),e.lineTo(s-n,i),e.arcTo(s,i,s,i+n,n),e.lineTo(s,l-n),e.arcTo(s,l,s-n,l,n),e.lineTo(t+n,l),e.arcTo(t,l,t,l-n,n),e.lineTo(t,i+n),e.arcTo(t,i,t+n,i,n),e.stroke()}mathWidthHeight(e,t){let i=t.measureText(e),s=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;return[i.width,s]}}class i{constructor(){if(i._instance)return i._instance;i._instance=this}buttonTryAgain={cursorOverbutton:0,set buttonXY(e){[this.buttonX1,this.buttonY1,this.buttonX2,this.buttonY2]=e}};moveDeltaXY={down:[0,90],up:[0,-90],left:[-90,0],right:[90,0]};score=0;cellArray=[];moveDirection;phaseTime=100;winStatus=0;loseStatus=0;moveDetected=0;columnArray={down:[[13,9,5,1],[14,10,6,2],[15,11,7,3],[16,12,8,4]],up:[[1,5,9,13],[2,6,10,14],[3,7,11,15],[4,8,12,16]],left:[[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,16]],right:[[4,3,2,1],[8,7,6,5],[12,11,10,9],[16,15,14,13]]};turnBlock=0;getCellFromNumber(e){return this.cellArray.find((function(t,i){return t.ticket==e}))}resetData(){this.winStatus=0,this.loseStatus=0,this.score=0,this.buttonTryAgain.visible=0,this.buttonTryAgain.cursorOverbutton=0,document.body.style.cursor="default",this.cellArray=[],this.turnBlock=0}make2ActiveCells(){let e,t=Math.floor(16*Math.random());do{e=Math.floor(16*Math.random())}while(e===t);let i=new s(t);this.cellArray.push(i),i=new s(e),this.cellArray.push(i),this.cellArray.forEach((function(e){e.value=2,e.valueOfDraw=2}))}make1ActiveCell(){let e;do{e=Math.floor(16*Math.random())}while(this.checkCellFunc(e));let t=new s(e);this.cellArray.push(t)}checkCellFunc(e){return this.cellArray.find((function(t){return t.ticket==e+1}))}deleteExcessCells(){this.cellArray=this.cellArray.filter((function(e){return 1!=e.toDelete}))}}function s(e){let t={value:9==Math.floor(10*Math.random())?4:2,toDelete:0,statusNewlyCreating:1,sizePenalty:0,statusEndedMerge:0,sizeBonus:0,set number(e){this._number=e,this.index=this._number-1,this.columnNumber=(this.index+1)%4!=0?(this.index+1)%4:4,this.rowNumber=Math.floor(this.index/4)+1,this.x=90*this.columnNumber-80,this.y=90*this.rowNumber-80,this.moveSpeed=0,this.mergeBlock=0,this.valueOfDraw=this.value},get number(){return this._number},animateMerge:function(e){if(0==this.statusEndedMerge)return 0;this.sizeBonus=1*e},animateCreating:function(e){if(0==this.statusNewlyCreating)return 0;this.sizePenalty=2*e},stopAnimating:function(){this.statusNewlyCreating=0,this.sizePenalty=0,this.statusEndedMerge=0,this.sizeBonus=0}};return t.number=e+1,t.ticket=t.number,t}class l{controller=new e;drawer=new t;field=new i;constructor(){if(l._instance)return l._instance;l._instance=this}run(){this.setupController(),this.startNewGame()}startNewGame(){this.field.resetData(),this.field.make2ActiveCells(),this.turn.mathCellResize(this),this.drawer.drawScore(this.field.score),this.drawer.runBodyDrawer(2*this.field.phaseTime,this.field.cellArray)}async makeTurn(e){await this.turn.runPhaseOne(e),await this.turn.runPhaseTwo(e),await this.turn.runPostTurnPhase(e)}turn={async runPhaseOne(e){e.drawer.runBodyDrawer(e.field.phaseTime,e.field.cellArray),this.setTickets(e),this.allMove(e),await this.delay(e)},async runPhaseTwo(e){this.mathCellResize(e),this.changeScore(e),e.field.deleteExcessCells(),e.checkTurnResult(),e.drawer.runBodyDrawer(e.field.phaseTime,e.field.cellArray),await this.delay(e)},async runPostTurnPhase(e){0==e.field.winStatus&&0==e.field.loseStatus&&(e.field.turnBlock=0)},delay:e=>new Promise((t=>setTimeout(t,e.field.phaseTime))),setTickets(e){for(let i=0;i<4;i++)t(1,i,e),t(2,i,e),t(3,i,e);function t(e,t,i){let s=i.field.columnArray[i.field.moveDirection],l=i.field.getCellFromNumber(s[t][e]);if(!l)return 0;let n=function(e,t){return i.field.columnArray[i.field.moveDirection][e].indexOf(t.number)}(t,l),r=e-1,a=e-2,o=e-3,u=i.field.getCellFromNumber(s[t][r]),c=i.field.getCellFromNumber(s[t][a]),d=i.field.getCellFromNumber(s[t][o]),h=l.number,f=0;function m(e,t){return e?.value==t.value&&0==e?.mergeBlock&&0==t.mergeBlock?1:0}m(u,l)&&(f=1,h=s[t][r],l.toDelete=1,u.value*=2,u.statusEndedMerge=1,u.mergeBlock=1,l.mergeBlock=1,i.field.moveDetected=1),!u&&n>0&&(f=1,h=s[t][r],i.field.moveDetected=1,m(c,l)&&(f=2,c.value*=2,c.statusEndedMerge=1,l.toDelete=1,h=s[t][a],c.mergeBlock=1,l.mergeBlock=1),!c&&n>1&&(f=2,h=s[t][a],m(d,l)&&(f=3,h=s[t][o],d.value*=2,d.statusEndedMerge=1,l.toDelete=1,d.mergeBlock=1,l.mergeBlock=1),!d&&n>2&&(f=3,h=s[t][o]))),l.ticket=h,l.moveSpeed=f}},allMove(e){let t=0,i=setInterval((()=>{t>4&&(clearInterval(i),e.field.cellArray.forEach((function(e){e.number=e.ticket}))),function(e){e.field.cellArray.forEach((function(t){t.x+=e.field.moveDeltaXY[e.field.moveDirection][0]*t.moveSpeed/(e.field.phaseTime/20),t.y+=e.field.moveDeltaXY[e.field.moveDirection][1]*t.moveSpeed/(e.field.phaseTime/20)}))}(e),t++}),e.field.phaseTime/5)},changeScore(e){let t=0;e.field.cellArray.forEach((function(e){1==e.toDelete&&(t+=e.valueOfDraw)})),e.field.score+=2*t,e.drawer.drawScore(e.field.score)},mathCellResize(e){let t=0,i=setInterval((()=>{e.field.cellArray.forEach((function(e){e.animateCreating(5-t),e.animateMerge(5-t)})),t++,t>4&&(clearInterval(i),e.field.cellArray.forEach((function(e){e.stopAnimating()})))}),10)}};adminComands={makePrewinSituation(e){e.field.cellArray[0].value=1024,e.field.cellArray[1].value=1024,e.field.cellArray[1].valueOfDraw=1024,e.field.cellArray[0].valueOfDraw=1024,e.drawer.drawCells(e.field.cellArray)},makePreloseSituation(e){e.field.cellArray=[];for(let t=0;t<15;t++)e.field.make1ActiveCell();for(let t=0;t<15;t++)e.field.cellArray[t].value=t+32,e.field.cellArray[t].valueOfDraw=t+32;e.drawer.drawCells(e.field.cellArray)}};setupController(){this.controller.doMove=this.rebind.doMove.bind(this),this.controller.checkMouseMove=this.rebind.checkMouseMove.bind(this),this.controller.buttonClick=this.rebind.buttonClick.bind(this),this.controller.touchButtonClick=this.rebind.touchButtonClick.bind(this),this.controller.pressEnter=this.rebind.pressEnter.bind(this),this.controller.openAdminPanel=this.rebind.openAdminPanel.bind(this),this.controller.triggerButton=this.rebind.triggerButton.bind(this),this.controller.init()}checkTurnResult(){return 1==this.field.moveDetected&&this.field.make1ActiveCell(),this.field.moveDetected=0,this.checkWin(this),1==this.field.winStatus?0:(this.checkLose(this),1==this.field.loseStatus?0:void 0)}checkWin(e){this.field.cellArray.map((function(e){return e.value})).includes(2048)&&(this.field.winStatus=1),1==this.field.winStatus&&setTimeout(this.makeWin,2*this.field.phaseTime,e)}checkLose(e){if(this.field.loseStatus=1,this.field.cellArray.length<16)return this.field.loseStatus=0,0;for(let e=0;e<4;e++)for(let t=0;t<3;t++)this.field.getCellFromNumber(this.field.columnArray.down[e][t])?.value==this.field.getCellFromNumber(this.field.columnArray.down[e][t+1])?.value&&(this.field.loseStatus=0);for(let e=0;e<4;e++)for(let t=0;t<3;t++)this.field.getCellFromNumber(this.field.columnArray.right[e][t])?.value==this.field.getCellFromNumber(this.field.columnArray.right[e][t+1])?.value&&(this.field.loseStatus=0);1==this.field.loseStatus&&setTimeout(this.makeLose,2*this.field.phaseTime,e)}makeLose(e){e.drawer.drawLose();let t=e.drawer.drawButton(e.field.buttonTryAgain);e.field.buttonTryAgain.buttonXY=t,e.field.buttonTryAgain.visible=1}makeWin(e){e.drawer.drawWin();let t=e.drawer.drawButton(e.field.buttonTryAgain);e.field.buttonTryAgain.buttonXY=t,e.field.buttonTryAgain.visible=1}rebind={doMove(e){if(1==this.field.turnBlock)return 0;this.field.turnBlock=1,this.field.moveDirection=e,this.makeTurn(this)},checkMouseMove(e){if(1==this.field.buttonTryAgain.visible){let t=document.getElementById("canvasBody");e.x>this.field.buttonTryAgain.buttonX1+t.offsetLeft&&e.x<this.field.buttonTryAgain.buttonX2+t.offsetLeft&&e.y>this.field.buttonTryAgain.buttonY1+t.offsetTop&&e.y<this.field.buttonTryAgain.buttonY2+t.offsetTop?(document.body.style.cursor="pointer",this.field.buttonTryAgain.cursorOverbutton=1):(document.body.style.cursor="default",this.field.buttonTryAgain.cursorOverbutton=0)}},buttonClick(){1==this.field.buttonTryAgain.cursorOverbutton&&1==this.field.buttonTryAgain.visible&&this.startNewGame()},touchButtonClick(e,t){elem=document.getElementById("canvasBody"),e>this.field.buttonTryAgain.buttonX1+elem.offsetLeft&&e<this.field.buttonTryAgain.buttonX2+elem.offsetLeft&&t>this.field.buttonTryAgain.buttonY1+elem.offsetTop&&t<this.field.buttonTryAgain.buttonY2+elem.offsetTop&&1==this.field.buttonTryAgain.visible&&this.startNewGame()},pressEnter(){1!=this.field.winStatus&&1!=this.field.loseStatus||this.startNewGame()},openAdminPanel(){document.getElementById("adminPanel").style="display: block"},triggerButton(e){switch(e.target.id){case"startNewGame":this.startNewGame();break;case"makeLose":this.makeLose(this);break;case"makeWin":this.makeWin(this);break;case"makePrewinSituation":this.adminComands.makePrewinSituation(this);break;case"makePreloseSituation":this.adminComands.makePreloseSituation(this)}}}}(new l).run()})();