(()=>{"use strict";class e{constructor(){if(e._instance)return e._instance;e._instance=this}init(){this.setKeyboardController(),this.setMouseController(),this.setTouchpadController(),this.setButtonsController()}setKeyboardController(){let t=new Array;document.addEventListener("keydown",(function(i){switch(i.code){case"ArrowUp":e.doMove("up");break;case"ArrowDown":e.doMove("down");break;case"ArrowLeft":e.doMove("left");break;case"ArrowRight":e.doMove("right");break;case"Enter":i.preventDefault(),e.pressEnter()}t.push(i.code),t.length>5&&t.shift(),t.join()==["KeyA","KeyD","KeyM","KeyI","KeyN"].join()&&e.openAdminPanel()}))}setMouseController(){let t,i,l,a;function n(n){return null===event||"touchstart"==event.type?0:(i=n.x,a=n.y,function(){let n,s=[i-t,a-l];if(Math.abs(s[0])+Math.abs(s[1])<200)return 0;Math.abs(s[0])>Math.abs(s[1])?e.axis="x":e.axis="y","y"==e.axis&&(n=s[1]>0?"down":"up"),"x"==e.axis&&(n=s[0]>0?"right":"left"),e.doMove(n)}(),void(Math.abs(i-t)+Math.abs(a-l)<5&&e.buttonClick()))}document.addEventListener("mousedown",(function(e){return null===event||"touchstart"==event.type?0:(t=e.x,l=e.y,void document.addEventListener("mouseup",n))})),document.addEventListener("mousemove",e.checkMouseMove)}setTouchpadController(){let t,i;function l(t,i,l){let a=t.x,n=t.y;Math.abs(i-a)+Math.abs(l-n)<5&&e.touchButtonClick(i,l)}document.addEventListener("touchstart",(function(l){document.addEventListener("touchmove",(function(e){l&&(t=e.touches[0].pageX-l.touches[0].pageX,i=e.touches[0].pageY-l.touches[0].pageY)}),event),document.addEventListener("touchend",(function(){return isNaN(Math.abs(t))||Math.abs(t)+Math.abs(i)<100?0:(Math.abs(t)>Math.abs(i)?e.axis="x":e.axis="y","y"==e.axis&&(moveTo=i>0?"down":"up"),"x"==e.axis&&(moveTo=t>0?"right":"left"),e.doMove(moveTo),void(l=null))}))}),event),document.addEventListener("touchstart",(function(){elem=document.getElementById("canvasBody");let e=event.touches[0]?.pageX,t=event.touches[0]?.pageY;document.addEventListener("touchend",l,event,e,t)}))}setButtonsController(){document.getElementById("startNewGame").addEventListener("click",e.triggerButton),document.getElementById("makeLose").addEventListener("click",e.triggerButton),document.getElementById("makeWin").addEventListener("click",e.triggerButton),document.getElementById("makePrewinSituation").addEventListener("click",e.triggerButton),document.getElementById("makePreloseSituation").addEventListener("click",e.triggerButton)}static triggerButton;doMove;static makeLose;static makeWin;static makePrewinSituation;static makePreloseSituation;static startNewGame;static checkMouseMove;static buttonClick;static touchButtonClick;static pressEnter;static openAdminPanel}class t{constructor(){if(t._instance)return t._instance;t._instance=this}size=80;minMargin=this.size/8;fullSize=4*this.size+5*this.minMargin;stepMargin=this.minMargin+this.size;textMarginSize=this.size/8*3;drawScore(e){let i=document.getElementById("canvasHead").getContext("2d");i.clearRect(0,0,canvasHead.width,canvasHead.height),i.font="bold "+35*this.size/80+"px sans-serif";let[l,a]=this.mathWidthHeight("SCORE:"+e,i);i.fillStyle="#bbada0";let n=l+this.textMarginSize,s=25*this.size/80,r=this.size/4,o=this.size/8;t.roundRect(i,(this.fullSize-n)/2-s,r,l+(this.fullSize-n)/2+s,r+a+2*o,20),i.strokeStyle="#776e65",t.roundRectStroke(i,(this.fullSize-n)/2-s,r,l+(this.fullSize-n)/2+s,r+a+2*o,20,5),i.fillStyle="#ebe4da",i.fillText("SCORE: "+e,(this.fullSize-n)/2,r+a+o)}runBodyDrawer(e,t){let i=setInterval((()=>{this.drawCells(t)}),10);setTimeout(clearInterval,e,i)}drawCells(e){let i=document.getElementById("canvasBody").getContext("2d");i.clearRect(0,0,canvasBody.width,canvasBody.height),this.drawBackground(),e.forEach((e=>{let l=e.valueOfDraw;switch(l){case 2:case 4:case 8:case 16:case 32:case 64:i.font="bold 50px sans-serif";break;case 128:case 256:case 512:i.font="bold 42px sans-serif";break;case 1024:case 2048:i.font="bold 35px sans-serif"}switch(l){case 2:i.fillStyle="#eee4da";break;case 4:i.fillStyle="#ede0c8";break;case 8:default:i.fillStyle="#f2b179";break;case 16:i.fillStyle="#f59563";break;case 32:i.fillStyle="#f67c5f";break;case 64:i.fillStyle="#f35c3d";break;case 128:i.fillStyle="#e7cf73";break;case 256:i.fillStyle="#ecca64";break;case 512:case 1024:i.fillStyle="#eac75c";break;case 2048:i.fillStyle="#e6bd4f"}switch(t.roundRect(i,e.x+e.sizePenalty-e.sizeBonus,e.y+e.sizePenalty-e.sizeBonus,e.x+this.size-e.sizePenalty+e.sizeBonus,e.y+this.size-e.sizePenalty+e.sizeBonus,3),l){case 2:case 4:default:i.fillStyle="#776e65";break;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:i.fillStyle="#f9f6f2"}let[a,n]=this.mathWidthHeight(l,i),s=(this.size-a)/2,r=(this.size-n)/2;i.fillText(l,e.x+s,e.y+r+n)}))}drawLose(){let e=document.getElementById("canvasBody").getContext("2d");e.fillStyle="rgba(255, 255, 255, 0.5)",t.roundRect(e,0,0,this.fullSize,this.fullSize,10),e.fillStyle="#776e65",e.font="bold 50px sans-serif";let[i,l]=this.mathWidthHeight("GAME OVER!",e),a=(this.fullSize-i)/2,n=(this.fullSize-l)/2;e.fillText("GAME OVER!",a,n+l)}drawWin(){let e=document.getElementById("canvasBody").getContext("2d");e.fillStyle="rgba(255, 215, 0, 0.5)",t.roundRect(e,0,0,this.fullSize,this.fullSize,10),e.fillStyle="#f9f6f2",e.font="bold 50px sans-serif";let[i,l]=this.mathWidthHeight("YOU WIN!",e),a=(this.fullSize-i)/2,n=(this.fullSize-l)/2;e.fillText("YOU WIN!",a,n+l)}drawBackground(){let e=document.getElementById("canvasBody").getContext("2d");e.fillStyle="#776e65",t.roundRect(e,0,0,this.fullSize,this.fullSize,10),e.fillStyle="#bbada0";for(let i=0;i<4;i++)for(let l=0;l<4;l++){let a=this.minMargin+this.stepMargin*l,n=this.minMargin+this.stepMargin*i;t.roundRect(e,a,n,a+this.size,n+this.size,3)}}drawButton(e){let i=document.getElementById("canvasBody").getContext("2d");i.fillStyle="#8f7a66",i.font="bold "+this.size/4+"px sans-serif";let[l,a]=this.mathWidthHeight("Try again",i),n=l+this.textMarginSize;return t.roundRect(i,(this.fullSize-n)/2,220,l+30+(this.fullSize-n)/2,a+15+220,3),i.fillStyle="#f9f6f2",i.fillText("Try again",(this.fullSize-l-10)/2+2,244),[(this.fullSize-n)/2,220,l+30+(this.fullSize-n)/2,a+15+220]}static roundRect(e,t,i,l,a,n){n=Math.min(n,(l-t)/2,(a-i)/2),e.beginPath(),e.moveTo(t+n,i),e.lineTo(l-n,i),e.arcTo(l,i,l,i+n,n),e.lineTo(l,a-n),e.arcTo(l,a,l-n,a,n),e.lineTo(t+n,a),e.arcTo(t,a,t,a-n,n),e.lineTo(t,i+n),e.arcTo(t,i,t+n,i,n),e.fill()}static roundRectStroke(e,t,i,l,a,n,s){e.lineWidth=s,n=Math.min(n,(l-t)/2,(a-i)/2),e.beginPath(),e.moveTo(t+n,i),e.lineTo(l-n,i),e.arcTo(l,i,l,i+n,n),e.lineTo(l,a-n),e.arcTo(l,a,l-n,a,n),e.lineTo(t+n,a),e.arcTo(t,a,t,a-n,n),e.lineTo(t,i+n),e.arcTo(t,i,t+n,i,n),e.stroke()}mathWidthHeight(e,t){let i=t.measureText(e),l=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;return[i.width,l]}}class i{constructor(e){this.random10Percent=Math.floor(10*Math.random()),this.value=2,9==this.random10Percent&&(this.value=4),this.number=e+1,this.ticket=this._number,this.toDelete=0,this.statusNewlyCreating=1,this.sizePenalty=0,this.statusEndedMerge=0,this.sizeBonus=0}set number(e){this._number=e,this.index=this._number-1,this.columnNumber=(this.index+1)%4!=0?(this.index+1)%4:4,this.rowNumber=Math.floor(this.index/4)+1,this.x=90*this.columnNumber-80,this.y=90*this.rowNumber-80,this.moveSpeed=0,this.mergeBlock=0,this.valueOfDraw=this.value}get number(){return this._number}animateMerge(e){if(0==this.statusEndedMerge)return 0;this.sizeBonus=1*e}animateCreating(e){if(0==this.statusNewlyCreating)return 0;this.sizePenalty=2*e}stopAnimating(){this.statusNewlyCreating=0,this.sizePenalty=0,this.statusEndedMerge=0,this.sizeBonus=0}}new i;class l{constructor(){if(l._instance)return l._instance;l._instance=this}buttonTryAgain={cursorOverbutton:0,set buttonXY(e){[this.buttonX1,this.buttonY1,this.buttonX2,this.buttonY2]=e}};moveDeltaXY={down:[0,90],up:[0,-90],left:[-90,0],right:[90,0]};score=0;cellArray=[];moveDirection;phaseTime=100;winStatus=0;loseStatus=0;moveDetected=0;columnArray={down:[[13,9,5,1],[14,10,6,2],[15,11,7,3],[16,12,8,4]],up:[[1,5,9,13],[2,6,10,14],[3,7,11,15],[4,8,12,16]],left:[[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,16]],right:[[4,3,2,1],[8,7,6,5],[12,11,10,9],[16,15,14,13]]};turnBlock=0;getCellFromNumber(e){return this.cellArray.find((function(t,i){return t.ticket==e}))}resetData(){this.winStatus=0,this.loseStatus=0,this.score=0,this.buttonTryAgain.visible=0,this.buttonTryAgain.cursorOverbutton=0,document.body.style.cursor="default",this.cellArray=[],this.turnBlock=0}make2ActiveCells(){let e,t=Math.floor(16*Math.random());do{e=Math.floor(16*Math.random())}while(e===t);let l=new i(t);this.cellArray.push(l),l=new i(e),this.cellArray.push(l),this.cellArray.forEach((function(e){e.value=2,e.valueOfDraw=2}))}make1ActiveCell(){let e;do{e=Math.floor(16*Math.random())}while(this.checkCellFunc(e));let t=new i(e);this.cellArray.push(t)}checkCellFunc(e){return this.cellArray.find((function(t){return t.ticket==e+1}))}deleteExcessCells(){this.cellArray=this.cellArray.filter((function(e){return 1!=e.toDelete}))}}class a{static controller=new e;static drawer=new t;static field=new l;constructor(){if(a._instance)return a._instance;a._instance=this}run(){this.setupController(),this.startNewGame()}startNewGame(){a.field.resetData(),a.field.make2ActiveCells(),a.mathCellResize(),a.drawer.drawScore(a.field.score),a.drawer.runBodyDrawer(2*a.field.phaseTime,a.field.cellArray)}async makeTurn(){await this.turn.runPhaseOne(),await this.turn.runPhaseTwo(),await this.turn.runPostTurnPhase()}turn={async runPhaseOne(){a.drawer.runBodyDrawer(a.field.phaseTime,a.field.cellArray),this.setTickets(),this.allMove(),await this.delay()},async runPhaseTwo(){a.mathCellResize(),this.changeScore(),a.field.deleteExcessCells(),a.gameStatus.checkTurnResult(),a.drawer.runBodyDrawer(a.field.phaseTime,a.field.cellArray),await this.delay()},async runPostTurnPhase(){0==a.field.winStatus&&0==a.field.loseStatus&&(a.field.turnBlock=0)},delay:()=>new Promise((e=>setTimeout(e,a.field.phaseTime))),setTickets(){for(let t=0;t<4;t++)e(1,t),e(2,t),e(3,t);function e(e,t){let i=a.field.columnArray[a.field.moveDirection],l=a.field.getCellFromNumber(i[t][e]);if(!l)return 0;let n=function(e,t){return a.field.columnArray[a.field.moveDirection][e].indexOf(t.number)}(t,l),s=e-1,r=e-2,o=e-3,u=a.field.getCellFromNumber(i[t][s]),c=a.field.getCellFromNumber(i[t][r]),d=a.field.getCellFromNumber(i[t][o]),h=l.number,f=0;function m(e,t){return e?.value==t.value&&0==e?.mergeBlock&&0==t.mergeBlock?1:0}m(u,l)&&(f=1,h=i[t][s],l.toDelete=1,u.value*=2,u.statusEndedMerge=1,u.mergeBlock=1,l.mergeBlock=1,a.field.moveDetected=1),!u&&n>0&&(f=1,h=i[t][s],a.field.moveDetected=1,m(c,l)&&(f=2,c.value*=2,c.statusEndedMerge=1,l.toDelete=1,h=i[t][r],c.mergeBlock=1,l.mergeBlock=1),!c&&n>1&&(f=2,h=i[t][r],m(d,l)&&(f=3,h=i[t][o],d.value*=2,d.statusEndedMerge=1,l.toDelete=1,d.mergeBlock=1,l.mergeBlock=1),!d&&n>2&&(f=3,h=i[t][o]))),l.ticket=h,l.moveSpeed=f}},allMove(){let e=0,t=setInterval((()=>{e>4&&(clearInterval(t),a.field.cellArray.forEach((function(e){e.number=e.ticket}))),a.field.cellArray.forEach((function(e){e.x+=a.field.moveDeltaXY[a.field.moveDirection][0]*e.moveSpeed/(a.field.phaseTime/20),e.y+=a.field.moveDeltaXY[a.field.moveDirection][1]*e.moveSpeed/(a.field.phaseTime/20)})),e++}),a.field.phaseTime/5)},changeScore(){let e=0;a.field.cellArray.forEach((function(t){1==t.toDelete&&(e+=t.valueOfDraw)})),a.field.score+=2*e,a.drawer.drawScore(a.field.score)}};static adminComands={makePrewinSituation(){a.field.cellArray[0].value=1024,a.field.cellArray[1].value=1024,a.field.cellArray[1].valueOfDraw=1024,a.field.cellArray[0].valueOfDraw=1024,a.drawer.drawCells(a.field.cellArray)},makePreloseSituation(){a.field.cellArray=[];for(let e=0;e<15;e++)a.field.make1ActiveCell();console.log(a.field.cellArray);for(let e=0;e<15;e++)a.field.cellArray[e].value=e+32,a.field.cellArray[e].valueOfDraw=e+32;a.drawer.drawCells(a.field.cellArray)}};setupController(){e.doMove=this.rebind.doMove.bind(this),e.checkMouseMove=this.rebind.checkMouseMove.bind(this),e.buttonClick=this.rebind.buttonClick.bind(this),e.touchButtonClick=this.rebind.touchButtonClick.bind(this),e.pressEnter=this.rebind.pressEnter.bind(this),e.openAdminPanel=this.rebind.openAdminPanel.bind(this),e.triggerButton=this.rebind.triggerButton.bind(this),a.controller.init()}static gameStatus={checkTurnResult:()=>(1==a.field.moveDetected&&a.field.make1ActiveCell(),a.field.moveDetected=0,a.gameStatus.checkWin(),1==a.field.winStatus?0:(a.gameStatus.checkLose(),1==a.field.loseStatus?0:void 0)),checkWin(){a.field.cellArray.map((function(e){return e.value})).includes(2048)&&(a.field.winStatus=1),1==a.field.winStatus&&setTimeout(a.gameStatus.makeWin,2*a.field.phaseTime)},checkLose(){if(a.field.loseStatus=1,a.field.cellArray.length<16)return a.field.loseStatus=0,0;for(let e=0;e<4;e++)for(let t=0;t<3;t++)a.field.getCellFromNumber(a.field.columnArray.down[e][t])?.value==a.field.getCellFromNumber(a.field.columnArray.down[e][t+1])?.value&&(a.field.loseStatus=0);for(let e=0;e<4;e++)for(let t=0;t<3;t++)a.field.getCellFromNumber(a.field.columnArray.right[e][t])?.value==a.field.getCellFromNumber(a.field.columnArray.right[e][t+1])?.value&&(a.field.loseStatus=0);1==a.field.loseStatus&&setTimeout(a.gameStatus.makeLose,2*a.field.phaseTime)},makeLose(){a.drawer.drawLose();let e=a.drawer.drawButton(a.field.buttonTryAgain);a.field.buttonTryAgain.buttonXY=e,a.field.buttonTryAgain.visible=1},makeWin(){a.drawer.drawWin();let e=a.drawer.drawButton(a.field.buttonTryAgain);a.field.buttonTryAgain.buttonXY=e,a.field.buttonTryAgain.visible=1}};rebind={doMove(e){if(1==a.field.turnBlock)return 0;a.field.turnBlock=1,a.field.moveDirection=e,this.makeTurn()},checkMouseMove(e){if(1==a.field.buttonTryAgain.visible){let t=document.getElementById("canvasBody");e.x>a.field.buttonTryAgain.buttonX1+t.offsetLeft&&e.x<a.field.buttonTryAgain.buttonX2+t.offsetLeft&&e.y>a.field.buttonTryAgain.buttonY1+t.offsetTop&&e.y<a.field.buttonTryAgain.buttonY2+t.offsetTop?(document.body.style.cursor="pointer",a.field.buttonTryAgain.cursorOverbutton=1):(document.body.style.cursor="default",a.field.buttonTryAgain.cursorOverbutton=0)}},buttonClick(){1==a.field.buttonTryAgain.cursorOverbutton&&1==a.field.buttonTryAgain.visible&&this.startNewGame()},touchButtonClick(e,t){elem=document.getElementById("canvasBody"),e>a.field.buttonTryAgain.buttonX1+elem.offsetLeft&&e<a.field.buttonTryAgain.buttonX2+elem.offsetLeft&&t>a.field.buttonTryAgain.buttonY1+elem.offsetTop&&t<a.field.buttonTryAgain.buttonY2+elem.offsetTop&&1==a.field.buttonTryAgain.visible&&this.startNewGame()},pressEnter(){1!=a.field.winStatus&&1!=a.field.loseStatus||this.startNewGame()},openAdminPanel(){document.getElementById("adminPanel").style="display: block"},triggerButton(e){switch(e.target.id){case"startNewGame":this.startNewGame();break;case"makeLose":a.gameStatus.makeLose();break;case"makeWin":a.gameStatus.makeWin();break;case"makePrewinSituation":a.adminComands.makePrewinSituation();break;case"makePreloseSituation":a.adminComands.makePreloseSituation()}}};static mathCellResize(){let e=0,t=setInterval((()=>{a.field.cellArray.forEach((function(t){t.animateCreating(5-e),t.animateMerge(5-e)})),e++,e>4&&(clearInterval(t),a.field.cellArray.forEach((function(e){e.stopAnimating()})))}),10)}}(new a).run()})();